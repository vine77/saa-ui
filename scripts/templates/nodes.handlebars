<div id="nodes" class="container-fluid">
  <div class="row-fluid">
    <div class="content">
      <div class="header row-fluid">
        <div class="span7">
          <div class="row-fluid">
            <div class="span6">
              <small>Used of Available vCPUs ({{totalVcpusMessage}})</small>
              <div class="progress progress-success">
                <div class="bar" {{bindAttr style="totalVcpusWidth"}}></div>
              </div>
            </div>
            <div class="span6">
              <small>Used of Available RAM ({{totalRamMessage}})</small>
              <div class="progress progress-success">
                <div class="bar" {{bindAttr style="totalRamWidth"}}></div>
              </div>
            </div>
          </div>
        </div>
        <div class="span5">
          <div class="global-actions"></div>
          {{!--
          <form id="filter-form" class="input-prepend clear-input pull-right">
            <span class="add-on"><i class="icon-search"></i></span>
            {{view Ember.TextField id="filter" type="search" valueBinding="filterQuery" placeholder="Filter nodes"}}
            <a class="close clear-button" type="reset" {{action "clearFilter"}}>&times;</a>
          </form>
          --}}
        </div>
      </div>
      <table class="table table-bordered expandable">
        <thead>
          <tr>
            <th class="column-small"><a {{action "selectAll"}} title="Select all"><i class="icon-check icon-large"></i></a></th>
            <th {{bindAttr class=":column-small :sortable isColumn2Sorted:sorted sortAscending"}}>
              {{#view App.TooltipView title="Health"}}
                <a {{action "sortModel" "health"}}><i class="icon-stethoscope icon-large"></i></a>
              {{/view}}
            </th>
            <th {{bindAttr class=":column-small :sortable isColumn3Sorted:sorted sortAscending"}}>
              {{#view App.TooltipView title="Operational State"}}
                <a {{action "sortModel" "state"}}><i class="icon-off icon-large"></i></a>
              {{/view}}
            </th>
            <th {{bindAttr class=":column-small :sortable isColumn4Sorted:sorted sortAscending"}}>
              {{#view App.TooltipView title="Trust Status"}}
                <a {{action "sortModel" "status.trust"}}><i class="icon-lock icon-large"></i></a>
              {{/view}}
            </th>
            <th {{bindAttr class=":column-small :sortable isColumn5Sorted:sorted sortAscending"}}>
              {{#view App.TooltipView title="Assured"}}
                <a {{action "sortModel" "isAssured"}}><i class="icon-trophy icon-large"></i></a>
              {{/view}}
            </th>
            <th {{bindAttr class=":sortable isColumn6Sorted:sorted sortAscending"}}>
              <a {{action "sortModel" "name"}}>Hostname</a>
            </th>
            <th {{bindAttr class=":sortable isColumn7Sorted:sorted sortAscending"}}>
              <a {{action "sortModel" "vmInfo.count"}}># of VMs</a>
            </th>
            <th {{bindAttr class=":sortable isColumn8Sorted:sorted sortAscending"}}>
              <a {{action "sortModel" "cpuFrequency"}}>CPU</a>
            </th>
            <th {{bindAttr class=":sortable isColumn9Sorted:sorted sortAscending"}}>
              {{#view App.TooltipView title="The SAM Unit (SU) is a measure of compute consumption of the host server"}}
                <a {{action "sortModel" "utilization.gips_current"}}>SU</a>
              {{/view}}
            </th>
            <th {{bindAttr class=":sortable isColumn10Sorted:sorted sortAscending"}}>
              {{#view App.TooltipView title="CPU instructions per cycle"}}
                <a {{action "sortModel" "utilization.ipc"}}>Throughput</a>
              {{/view}}
            </th>
            <th {{bindAttr class=":sortable isColumn11Sorted:sorted sortAscending"}}>
              {{#view App.TooltipView title="Memory utilization"}}
                <a {{action "sortModel" "utilization.memory"}}>Memory</a>
              {{/view}}
            </th>
            <th {{bindAttr class=":sortable isColumn12Sorted:sorted sortAscending"}}>
              {{#view App.TooltipView title="LLC Cache Contention"}}
                <a {{action "sortModel" "contention.system.llc.value"}}>Contention</a>
              {{/view}}
            </th>
            <th>Actions</th>
            <th class="column-small">
              <a {{action refresh}} class="btn btn-mini"><i {{bindAttr class=":icon-refresh content.isUpdating:icon-spin content.isUpdating:disabled"}}></i></a>
            </th>
          </tr>
        </thead>
        <tbody>
          {{#each node in controller}}
            <tr {{bindAttr class="node.isSelected node.isExpanded node.isAgentInstalled node.isScheduled"}}>
              <td class="column-small">
                {{#if node.isAgentInstalled}}
                  {{view Ember.Checkbox checkedBinding="node.isSelected"}}
                {{/if}}
              </td>
              <td class="column-small">
                {{#view App.TooltipView titleBinding="node.healthMessage"}}
                  {{healthIcon node.status.health}}
                {{/view}}
              </td>
              <td class="column-small">
                {{#view App.TooltipView titleBinding="node.status.operationalMessage"}}
                  {{operationalIcon node.status.operational}}
                {{/view}}
              </td>
              <td class="column-small">
                {{#if node.isTrustRegistered}}
                  {{#view App.TooltipView titleBinding="node.status.trustMessage"}}
                    {{#if node.status.isTrustUnknown}}
                      <i class="icon-large icon-question-sign trust-unknown"></i>
                    {{else}}
                      <i {{bindAttr class=":icon-large node.status.isTrusted:icon-lock:icon-unlock node.status.isTrusted:trusted:untrusted"}}></i>
                    {{/if}}
                  {{/view}}
                {{else}}
                  {{#view App.TooltipView titleBinding="node.isTrustRegisteredMessage"}}
                    <i class="icon-large icon-unlock trust-unregistered"></i>
                  {{/view}}
                {{/if}}
              </td>
              <td class="column-small">
                {{#view App.TooltipView titleBinding="node.assuredMessage"}}
                  <i {{bindAttr class=":icon-large :icon-trophy node.isAssured:assured:unassured"}}></i>
                {{/view}}
              </td>
              <td>
                {{#if node.isAgentInstalled}}
                  <a {{action "expand" node}}>{{node.name}}</a>
                  {{#if node.isScheduled}}
                    {{#view App.TooltipView titleBinding="node.scheduledMessage"}}
                      <i class="icon-magnet"></i>
                    {{/view}}
                  {{/if}}
                {{else}}
                  {{node.name}}
                {{/if}}
              </td>
              <td>{{na node.vmInfo.count}}</td>
              <td>
                <div class="cpu-typography">
                  <div class="sockets-and-cores">
                    <div class="sockets">{{na node.capabilities.sockets}} CPUs </div>
                    <div class="cores">&times; {{na node.capabilities.cores_per_socket}} cores </div>
                  </div>
                  <div class="cpu-frequency">
                    <span class="at">@</span>
                    {{na node.cpuFrequency}}
                  </div>
                </div>
              </td>
              <td>{{na node.utilization.gips_current}}</td>
              <td>{{na node.utilization.ipc}}</td>
              <td>{{readableSize node.utilization.memory}}</td>
              <td>
                {{#if node.contention.system.llc.valueExists}}
                  <div class="contention">
                    <div class="contention-bar">
                      {{#view App.TooltipView titleBinding="node.contention.system.llc.contentionMessage"}}
                        <div class="contention-bar-width" {{bindAttr style="node.contention.system.llc.width"}}>
                          <div class="contention-gradient"></div>
                        </div>
                      {{/view}}
                    </div>
                    {{na node.contention.system.llc.valueFormatted}}
                  </div>
                {{else}}
                  <span class="not-applicable">n/a</span>
                {{/if}}
              </td>
              <td>
                <div class="btn-group">
                  {{#if node.isAgentInstalled}} 
                    {{#if node.isOn}}
                      <a {{action reboot node}} class="btn btn-mini"><i class="icon-refresh"></i> Reboot</a>
                    {{else}}
                      <a class="btn disabled btn-mini"><i class="icon-bolt"></i> Power On</a>
                    {{/if}}
                    <a data-toggle="dropdown" class="btn dropdown-toggle btn-mini"><span class="caret"></span></a>
                    <ul class="dropdown-menu">
                      {{#if App.mtWilson.isInstalled}}
                        {{#if node.trustNode.ipaddress}}
                          <li><a {{action removeTrust node}}><i class="icon-unlock"></i> Remove Trust</a></li>
                        {{else}}
                          <li><a {{action addTrust node}}><i class="icon-lock"></i> Add Trust</a></li>
                        {{/if}}
                        <li><a {{action trustFingerprint node}}><i class="icon-hand-up"></i> Fingerprint</a></li>
                      {{/if}}
                      <li><a {{action exportTrustReport node}}><i class="icon-external-link"></i> Export Trust Report </a></li>
                      {{#if node.isScheduled}}
                        <li><a {{action unschedule node}}><i class="icon-magnet"></i> Unset for VM placement</a></li>
                      {{else}}
                        {{#each node.capabilities.socketsEnum}}
                          <li><a {{action schedule node this}}><i class="icon-magnet"></i> Place VMs on Socket {{this}}</a></li>
                        {{/each}}
                      {{/if}}
                      {{#if node.samRegistered}}
                        <li><a {{action unregister node}}><i class="icon-remove"></i> Unregister</a></li>
                      {{/if}}
                    </ul>
                  {{else}}
                    {{#if node.samRegistered}}
                      <a {{action unregister node}}><i class="icon-remove"></i> Unregister</a>
                    {{/if}}
                  {{/if}}
                </div>
              </td>
              <td class="column-small">
                {{#if node.isAgentInstalled}}
                  <a class="btn btn-mini toggle-details" {{action "expand" node}}>
                    <i {{bindAttr class="node.isActive:icon-minus:icon-plus"}}></i>
                  </a>
                {{/if}}
              </td>
            </tr>
            <tr class="expandable-row">
              <td colspan="100%">
                <div class="details">
                  <ul class="nav nav-tabs">
                    <li class="active"><a onclick="App.selectTab(event)">Details</a></li>
                    <li><a onclick="App.selectTab(event)">Utilization</a></li>
                    <li><a onclick="App.selectTab(event)">Capabilities</a></li>
                    <li><a onclick="App.selectTab(event)">VMs</a></li>
                    <li><a onclick="App.selectTab(event)">Graphs</a></li>
                    <li><a onclick="App.selectTab(event)">Trust</a></li>
                    <li><a onclick="App.selectTab(event)">PCR logs</a></li>
                    <li><a onclick="App.selectTab(event)">MLEs</a></li>
                  </ul>
                  <div class="tab-content">
                    <div class="tab-pane active details">
                      <table class="table table-bordered">
                        <tr>
                          <th>Hostname</th>
                          <th>Health</th>
                          <th>Operational State</th>
                          <th>Trusted</th>
                          <th>Locked</th>
                          <th>vCPUs</th>
                          {{#if node.isScheduled}}
                            <th>VM Placement</th>
                          {{/if}}
                        </tr>
                        <tr>
                          <td>{{node.name}}</td>
                          <td>
                            {{#view App.TooltipView titleBinding="node.healthMessage"}}
                              {{healthIcon node.status.health}} {{status node.status.health}}
                            {{/view}}
                          </td>
                          <td>
                            {{operationalIcon node.status.operational}} {{operational node.status.operational}}
                          </td>
                          <td>{{capitalize node.status.trust}}</td>
                          <td>{{capitalize node.status.locked}}</td>
                          <td>{{na node.vcpus.used}} out of {{na node.vcpus.max}}</td>
                          {{#if node.isScheduled}}
                            <td>Socket {{node.schedulerMark}}</td>
                          {{/if}}
                        </tr>
                      </table>
                    </div>
                    <div class="tab-pane utilization">
                      <table class="table table-bordered">
                        <tr>
                          <th>SAM Units</th>
                          <th>CPU Throughput</th>
                          <th>Memory</th>
                          <th>CPU Idle</th>
                          <th>I/O Wait</th>
                        </tr>
                        <tr>
                          <td>{{na node.utilization.gips_current}} out of {{na node.utilization.gips_max}}</td>
                          <td>{{na node.utilization.ipc}}</td>
                          <td>{{readableSize node.utilization.memory}} out of {{readableSize node.capabilities.memory_size}}</td>
                          <td>{{na node.utilization.cpu.idle}}</td>
                          <td>{{na node.utilization.cpu.iowait}}</td>
                        </tr>
                      </table>
                    </div>
                    <div class="tab-pane capabilities">
                      <table class="table table-bordered">
                        <tr>
                          <th>Sockets</th>
                          <th>Cores per Socket</th>
                          <th>CPU Frequency</th>
                          <th>Hyperthreading</th>
                          <th>Turbo Mode</th>
                          <th>Cache Size</th>
                          <th>Memory Size</th>
                        </tr>
                        <tr>
                          <td>{{na node.capabilities.sockets}}</td>
                          <td>{{na node.capabilities.cores_per_socket}}</td>
                          <td>{{na node.capabilities.cpu_frequency}}</td>
                          <td>{{capitalize node.capabilities.hyperthreading}}</td>
                          <td>{{capitalize node.capabilities.turbo_mode}}</td>
                          <td>{{readableSize node.capabilities.cache_size}}</td>
                          <td>{{readableSize node.capabilities.memory_size}}</td>
                        </tr>
                      </table>
                    </div>
                    <div class="tab-pane vms">
                      <ul>
                        {{#each vm in node.vms}}
                          <li>{{#linkTo "vmsVm" vm}}{{vm.name}}{{/linkTo}}</li>
                        {{else}}
                          <li>No VMs</li>
                        {{/each}}
                      </ul>
                    </div>
                    <div class="tab-pane graphs">
                      {{#each graph in node.graphs}}
                        <figure class="thumbnail">
                          <img {{bindAttr src="graph.url"}}>
                          <figcaption class="caption">{{graph.desc}}</figcaption>
                        </figure>
                      {{/each}}
                    </div>
                    <div class="tab-pane trust">
                      {{#if node.nodeTrustReport.attestations}}
                        <div class="align-right">
                          <button class="btn btn-primary" {{action trustReportModal node}}>Generate Trust Report</button>
                        </div>
                        <table class="table table-bordered">
                          <tr>
                            <th class="column-small">Trust Status</th>
                            <th>Message</th>
                            <th>Timestamp</th>
                          </tr>
                          {{#each attestation in node.nodeTrustReport.attestations}}
                            <tr>
                              <td class="column-small">
                                {{#view App.TooltipView titleBinding="attestation.trust_message" dataContainer="body"}}
                                  <i {{bindAttr class=":icon-large attestation.trust_status:icon-lock:icon-unlock attestation.trust_status:trusted:untrusted"}}></i>
                                {{/view}}
                              </td>
                              <td>{{attestation.report_message}}</td>
                              <td>{{attestation.attestation_time_formatted}}</td>
                            </tr>
                          {{/each}}
                        </table>
                      {{else}}
                        {{#unless content.isUpdating}}
                          <div class="alert alert-info">No attestations found.</div>
                        {{/unless}}
                      {{/if}}
                    </div>
                    <div class="tab-pane pcr-logs">
                      {{#if node.trustNode.pcrLogs}}
                        <table class="table table-bordered">
                          <tr>
                            <th class="column-small">Trust Status</th>
                            <th>Name</th>
                            <th>Actual Value</th>
                            <th>Expected Value</th>
                            <th>Module Logs</th>
                          </tr>
                          {{#each log in node.trustNode.pcrLogs}}
                            <tr>
                              <td class="column-small">
                                <i {{bindAttr class=":icon-large log.truststatus:icon-lock:icon-unlock log.truststatus:trusted:untrusted"}}></i>
                              </td>
                              <td>{{na log.name}}</td>
                              <td>{{na log.value}}</td>
                              <td>{{na log.whitelistvalue}}</td>
                              <td>
                                {{#if log.modulelogs}}
                                  {{#each modulelog in log.modulelogs}}
                                    <ul>
                                      <li>Component Name: {{modulelog.componentname}}</li>
                                      <li>Whitelist Value: {{modulelog.whitelistvalue}}</li>
                                      <li>Trust Status: {{modulelog.truststatus}}</li>
                                    </ul>
                                  {{/each}}
                                {{else}}
                                  {{na 'false'}}
                                {{/if}}
                              </td>
                            </tr>
                          {{/each}}
                        </table>
                      {{else}}
                        {{#unless content.isUpdating}}
                          <div class="alert alert-info">No PCR logs found.</div>
                        {{/unless}}
                      {{/if}}
                    </div>

                    <div class="tab-pane mles">
                      {{#if node.isTrustRegistered}}
                        <table class="table table-bordered">
                          <tr>
                            <th>MLE Type</th>
                            <th>Name</th>
                            <th>OEM Name</th>
                            <th>Attestation Type</th>
                            <th>OS Name</th>
                            <th>Version</th>
                            <th>OS Version</th>
                          </tr>
                          {{#each mle in node.trustNode.trustMle}}
                            <tr>
                              <td>{{na mle.mleType}}</td>
                              <td>{{#linkTo "trust.mle" mle}}{{na mle.name}}{{/linkTo}}</td>
                              <td>{{na mle.oemname}}</td>
                              <td>{{na mle.attestationType}}</td>
                              <td>{{na mle.osname}}</td>
                              <td>{{na mle.version}}</td>
                              <td>{{na mle.osversion}}</td>
                            </tr>
                          {{/each}}
                        </table>
                      {{else}}
                        {{#unless content.isUpdating}}
                          <div class="alert alert-info">No MLEs found.</div>
                        {{/unless}}
                      {{/if}}
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          {{else}}
            <tr>
              <td colspan="100%">
                {{#unless content.isUpdating}}
                  <div class="alert alert-info">No nodes found.</div>
                {{/unless}}
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>
</div>
